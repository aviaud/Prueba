<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- ğŸ”‘ Responsivo total -->
<title>InventarioWeb</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-size: 0.95rem; }
  h1 { font-size: 1.8rem; }
  @media(min-width:768px){ h1 { font-size:2rem; } }
  @media(min-width:1200px){ h1 { font-size:2.2rem; } }
  .card { border-radius: 0.8rem; }
  .btn-sm { font-size: 0.85rem; }
  input { font-size: 0.9rem; }
</style>
</head>
<body class="bg-light">

<div class="container my-3" id="contenido" style="display:none;">
  <h1 class="text-center mb-4">ğŸ“¦ InventarioWeb</h1>

  <!-- Formulario -->
  <div class="card shadow p-3 mb-4">
    <h5 class="card-title mb-3">â• Agregar / Editar Producto</h5>
    <form id="formProducto" class="row g-2 g-md-3">
      <div class="col-12 col-md-3">
        <input type="text" id="codigo" class="form-control" placeholder="CÃ³digo" required>
      </div>
      <div class="col-12 col-md-5">
        <input type="text" id="descripcion" class="form-control" placeholder="DescripciÃ³n" required>
      </div>
      <div class="col-12 col-md-2">
        <input type="number" step="0.01" id="cantidad" class="form-control" placeholder="Cantidad" required>
      </div>
      <div class="col-12 col-md-2 d-grid">
        <button type="submit" class="btn btn-success">ğŸ’¾ Guardar</button>
      </div>
    </form>
  </div>

  <!-- Inventario -->
  <div class="card shadow p-3 mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-2 gap-2">
      <h5 class="card-title mb-0">ğŸ“‹ Inventario Actual</h5>
      <input type="text" id="buscar" class="form-control w-100 w-md-50" placeholder="ğŸ” Buscar en inventario...">
    </div>
    <div class="mb-2 d-flex flex-wrap gap-2">
      <button onclick="exportarCSV()" class="btn btn-primary btn-sm">ğŸ“¤ Exportar CSV</button>
      <label class="btn btn-secondary btn-sm mb-0">
        ğŸ“¥ Importar CSV <input type="file" id="importarCSV" accept=".csv" onchange="importarCSV(event)" hidden>
      </label>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <thead class="table-dark">
          <tr><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Cantidad</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tablaInventario"></tbody>
      </table>
    </div>
  </div>

  <!-- CatÃ¡logo -->
  <div class="card shadow p-3 mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-2 gap-2">
      <h5 class="card-title mb-0">ğŸ“‘ CatÃ¡logo</h5>
      <input type="text" id="buscarCatalogo" class="form-control w-100 w-md-50" placeholder="ğŸ” Buscar en catÃ¡logo...">
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead class="table-light">
          <tr><th>CÃ³digo</th><th>DescripciÃ³n</th></tr>
        </thead>
        <tbody id="tablaCatalogo"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzQ4S4YDHiqqS-O_WvIIs0MKz3JFweuyYPATBDLyOz7l5V3Dn-auGuMzCm8wOi_nWS7/exec"; 
const PASSWORD = "123456";

let catalogo = [];
let inventario = [];

function login(){
  const clave = prompt("Ingrese la contraseÃ±a para acceder:");
  if(clave === PASSWORD){
    document.getElementById('contenido').style.display = "block";
    cargarCatalogo();
    cargarInventario();
  } else {
    alert("âŒ ContraseÃ±a incorrecta.");
    document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>ğŸš« Acceso bloqueado</h2>";
  }
}

function cargarCatalogo(){
  fetch(API_URL+"?action=getCatalogo")
    .then(r=>r.json())
    .then(data=>{ catalogo = data || []; mostrarCatalogo(catalogo); })
    .catch(err=>alert("âŒ Error al cargar catÃ¡logo: "+err));
}

function mostrarCatalogo(data){
  const tbody = document.getElementById('tablaCatalogo');
  tbody.innerHTML = '';
  (data||[]).forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item[0]}</td><td>${item[1]}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('buscarCatalogo').addEventListener('input', e=>{
  const filtro = e.target.value.toLowerCase();
  const filtrados = catalogo.filter(item =>
    String(item[0]).toLowerCase().includes(filtro) ||
    String(item[1]).toLowerCase().includes(filtro)
  );
  mostrarCatalogo(filtrados);
});

function cargarInventario(){
  fetch(API_URL+"?action=getInventario")
    .then(r=>r.json())
    .then(data=>{ inventario = data || []; mostrarInventario(inventario); })
    .catch(err=>alert("âŒ Error al cargar inventario: "+err));
}

function mostrarInventario(data){
  const tbody = document.getElementById('tablaInventario');
  tbody.innerHTML = '';
  (data||[]).forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item[0]}</td>
      <td>${item[1]}</td>
      <td>${item[2]}</td>
      <td>
        <button class="btn btn-warning btn-sm me-1" onclick="editarProducto('${item[0]}')">âœï¸ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarProducto('${item[0]}')">ğŸ—‘ Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('codigo').addEventListener('input', ()=>{
  const codigo = document.getElementById('codigo').value.trim();
  const item = catalogo.find(x=>x[0]===codigo);
  if(item) document.getElementById('descripcion').value = item[1];
});

document.getElementById('formProducto').addEventListener('submit', async e=>{
  e.preventDefault();
  const codigo = document.getElementById('codigo').value.trim();
  const descripcion = document.getElementById('descripcion').value.trim();
  let cantidad = parseFloat(document.getElementById('cantidad').value);

  if(!codigo || !descripcion || isNaN(cantidad)){ alert("Completa todos los campos"); return; }

  const existente = inventario.find(x=>x[0]===codigo);
  if(existente && confirm("Producto existe, acumular cantidades?")) cantidad += parseFloat(existente[2]);

  const data = { action:"guardar", codigo, descripcion, cantidad };
  try{
    const res = await fetch(API_URL,{method:"POST",body:JSON.stringify(data)});
    if(!res.ok) throw new Error("HTTP "+res.status);
    alert("âœ… Producto guardado");
    document.getElementById('formProducto').reset();
    cargarInventario();
  } catch(err){ alert("âŒ Error guardando: "+err); }
});

function editarProducto(codigo){
  const item = inventario.find(x=>x[0]===codigo);
  if(item){
    document.getElementById('codigo').value = item[0];
    document.getElementById('descripcion').value = item[1];
    document.getElementById('cantidad').value = item[2];
    window.scrollTo({ top:0, behavior:'smooth' });
  }
}

function eliminarProducto(codigo){
  if(confirm("âš ï¸ Eliminar este producto?")){
    const data = { action:"eliminar", codigo };
    fetch(API_URL,{method:"POST",body:JSON.stringify(data)})
      .then(r=>r.json())
      .then(()=>{ alert("ğŸ—‘ Producto eliminado"); cargarInventario(); })
      .catch(err=>alert("âŒ Error eliminando: "+err));
  }
}

document.getElementById('buscar').addEventListener('input', e=>{
  const filtro = e.target.value.toLowerCase();
  mostrarInventario(inventario.filter(item=>
    String(item[0]).toLowerCase().includes(filtro) ||
    String(item[1]).toLowerCase().includes(filtro)
  ));
});

function exportarCSV(){
  let csv = "CÃ³digo,DescripciÃ³n,Cantidad\n";
  inventario.forEach(row=>{ csv+=`${row[0]},${row[1]},${row[2]}\n`; });
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "inventario.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

async function importarCSV(event){
  const file = event.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async e=>{
    const lineas = e.target.result.split(/\r?\n/).slice(1).filter(l=>l.trim());
    for(const l of lineas){
      const partes = l.split(",").map(x=>x.trim());
      const codigo = partes[0];
      const cantidad = partes.pop();
      const descripcion = partes.slice(1).join(",");
      if(codigo && descripcion && !isNaN(parseFloat(cantidad))){
        const data = { action:"guardar", codigo, descripcion, cantidad: parseFloat(cantidad) };
        try{ const res = await fetch(API_URL,{method:"POST",body:JSON.stringify(data)});
              if(!res.ok) throw new Error("HTTP "+res.status);
        } catch(err){ console.error("Error guardando", codigo, err); }
      }
    }
    alert("ğŸ“¥ ImportaciÃ³n completada.");
    cargarInventario();
  };
  reader.readAsText(file);
}

window.onload = login;
</script>
</body>
</html>

